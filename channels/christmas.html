<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merry Christmas! - My MTV</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            min-height: 100vh;
        }
        
        .snow-container {
            position: fixed;
            height: 100%;
            width: 100%;
            top: 0;
            left: 0;
            overflow: hidden;
            z-index: 1;
            pointer-events: none;
        }

        .snow {
            display: block;
            position: absolute;
            z-index: 1;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            pointer-events: none;
            transform: translate3d(0, -100%, 0);
            animation: snow linear infinite;
        }

        /* Layer-specific settings */
        .snow.foreground {
            background-image: url('../data/foreground.png');
            animation-duration: 15s;
        }
        .snow.foreground.layered {
            animation-delay: 7.5s;
        }

        .snow.middleground {
            background-image: url('../data/middleground.png');
            animation-duration: 20s;
        }
        .snow.middleground.layered {
            animation-delay: 10s;
        }

        .snow.background {
            background-image: url('../data/background.png');
            animation-duration: 30s;
        }
        .snow.background.layered {
            animation-delay: 15s;
        }

        @keyframes snow {
            0% { transform: translate3d(0, -100%, 0); }
            100% { transform: translate3d(15%, 100%, 0); }
        }
        
        .header {
            background: linear-gradient(90deg, #ff0000, #ff6600);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            position: relative;
            z-index: 10;
        }
        
        .channel-logo {
            font-size: 36px;
            font-weight: bold;
        }
        
        .back-button {
            background: rgba(255,255,255,0.2);
            color: #fff;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 5px;
            transition: background 0.3s;
        }
        
        .back-button:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .player-container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
            position: relative;
            z-index: 5;
        }
        
        #player-wrapper {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            border: 3px solid #ff6600;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(255, 102, 0, 0.3);
        }
        
        #player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .loading {
            text-align: center;
            padding: 100px 20px;
            font-size: 24px;
            color: #aaa;
        }
        
        .info-bar {
            background: #1a1a1a;
            padding: 20px;
            margin-top: 20px;
            border-radius: 10px;
        }
        
        .now-playing {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .now-playing h3 {
            color: #ff6600;
            margin-bottom: 5px;
            font-size: 18px;
        }
        
        .now-playing p {
            color: #fff;
            font-size: 16px;
        }
        
        .video-counter {
            text-align: center;
            color: #aaa;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }
        
        .control-btn {
            background: #ff6600;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        .control-btn:hover {
            background: #ff8800;
        }
        
        .reset-btn {
            background: #666;
        }
        
        .reset-btn:hover {
            background: #888;
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }
            .channel-logo {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <div class="snow-container">
        <div class="snow background"></div>
        <div class="snow middleground layered"></div>
        <div class="snow foreground layered"></div>
    </div>

    <div class="header">
        <div class="channel-logo">üéÑ Merry Christmas!</div>
        <a href="../index.html" class="back-button">‚Üê Back to Channels</a>
    </div>
    
    <div class="player-container">
        <div id="loading" class="loading">
            Loading your playlist...
        </div>
        <div id="player-wrapper" style="display: none;">
            <div id="player"></div>
        </div>
    </div>
    
    <div class="player-container">
        <div class="info-bar">
            <div class="now-playing">
                <h3>Now Playing</h3>
                <p id="current-video">Loading...</p>
                <div class="video-counter" id="video-counter">Video 1 of 0</div>
            </div>
            <div class="controls">
                <button class="control-btn" onclick="skipVideo()">Skip to Next ‚è≠</button>
                <button class="control-btn reset-btn" onclick="resetPlaylist()">üîÄ Reshuffle Playlist</button>
            </div>
        </div>
    </div>

    <script>
        const CHANNEL_NAME = 'christmas';
        const PLAYLIST_KEY = `mtv_playlist_${CHANNEL_NAME}`;
        const INDEX_KEY = `mtv_index_${CHANNEL_NAME}`;
        
        // Load YouTube IFrame API
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        let player;
        let playlist = [];
        let currentVideoIndex = 0;

        // Shuffle array function
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Load or initialize playlist from localStorage
        async function loadPlaylist() {
            try {
                // Check if we have a saved playlist
                const savedPlaylist = localStorage.getItem(PLAYLIST_KEY);
                const savedIndex = localStorage.getItem(INDEX_KEY);
                
                if (savedPlaylist && savedIndex !== null) {
                    // Resume from saved state
                    playlist = JSON.parse(savedPlaylist);
                    currentVideoIndex = parseInt(savedIndex);
                    console.log(`Resuming playlist at video ${currentVideoIndex + 1} of ${playlist.length}`);
                } else {
                    // First time - load and shuffle
                    const response = await fetch('../data/christmas.json');
                    if (!response.ok) throw new Error('Failed to load playlist');
                    
                    const videos = await response.json();
                    const videoIds = videos.map(v => 
                        typeof v === 'string' ? v : v.youtube_id
                    );
                    
                    playlist = shuffleArray(videoIds);
                    currentVideoIndex = 0;
                    
                    // Save to localStorage
                    localStorage.setItem(PLAYLIST_KEY, JSON.stringify(playlist));
                    localStorage.setItem(INDEX_KEY, '0');
                    
                    console.log(`Loaded fresh playlist with ${playlist.length} videos`);
                }
                
                return playlist;
                
            } catch (error) {
                console.error('Error loading playlist:', error);
                document.getElementById('loading').innerHTML = 
                    `<p style="color: #ff6600;">Error loading playlist: ${error.message}</p>`;
                throw error;
            }
        }

        // Save current position
        function savePosition(index) {
            localStorage.setItem(INDEX_KEY, index.toString());
        }

        // Advance to next video and reload page
        function advanceToNextVideo() {
            currentVideoIndex++;
            
            // Check if we've reached the end
            if (currentVideoIndex >= playlist.length) {
                console.log('End of playlist - reshuffling...');
                playlist = shuffleArray(playlist);
                currentVideoIndex = 0;
                localStorage.setItem(PLAYLIST_KEY, JSON.stringify(playlist));
            }
            
            // Save new position
            savePosition(currentVideoIndex);
            
            // Reload the page to play next video
            console.log(`Reloading page to play video ${currentVideoIndex + 1}`);
            window.location.reload();
        }

        // Manual skip function
        function skipVideo() {
            advanceToNextVideo();
        }

        // Reset playlist (reshuffle)
        function resetPlaylist() {
            if (confirm('Reshuffle the playlist and start over?')) {
                localStorage.removeItem(PLAYLIST_KEY);
                localStorage.removeItem(INDEX_KEY);
                window.location.reload();
            }
        }

        // Called automatically when YouTube IFrame API is ready
        function onYouTubeIframeAPIReady() {
            loadPlaylist().then(() => {
                if (playlist.length === 0) {
                    document.getElementById('loading').innerHTML = 
                        '<p style="color: #ff6600;">No videos in playlist</p>';
                    return;
                }

                // Create the player with current video
                const currentVideoId = playlist[currentVideoIndex];
                console.log(`Playing video ${currentVideoIndex + 1}: ${currentVideoId}`);
                
                player = new YT.Player('player', {
                    height: '100%',
                    width: '100%',
                    videoId: currentVideoId,
                    playerVars: {
                        autoplay: 1,
                        controls: 1,
                        modestbranding: 1,
                        rel: 0,
                        iv_load_policy: 3,
                        fs: 1,
                        playsinline: 1
                    },
                    events: {
                        onReady: onPlayerReady,
                        onStateChange: onPlayerStateChange,
                        onError: onPlayerError
                    }
                });
            }).catch(error => {
                console.error('Failed to initialize player:', error);
            });
        }

        function onPlayerReady(event) {
            // Hide loading, show player
            document.getElementById('loading').style.display = 'none';
            document.getElementById('player-wrapper').style.display = 'block';
            
            // Start playing
            event.target.playVideo();
            updateNowPlaying();
        }

        function onPlayerStateChange(event) {
            // When video ends, advance and reload
            if (event.data === YT.PlayerState.ENDED) {
                console.log('Video ended - advancing to next and reloading page...');
                advanceToNextVideo();
            }
            
            // Update now playing when video starts
            if (event.data === YT.PlayerState.PLAYING) {
                updateNowPlaying();
            }
        }

        function onPlayerError(event) {
            console.log(`Error playing video ${playlist[currentVideoIndex]}: Error code ${event.data}`);
            console.log('Auto-skipping to next video...');
            
            // Skip to next video on error
            advanceToNextVideo();
        }

        function updateNowPlaying() {
            // Update counter
            document.getElementById('video-counter').textContent = 
                `Video ${currentVideoIndex + 1} of ${playlist.length}`;
            
            // Try to get video metadata from YouTube
            if (player && player.getVideoData) {
                setTimeout(() => {
                    try {
                        const videoData = player.getVideoData();
                        if (videoData && videoData.title) {
                            const title = videoData.title || 'Unknown';
                            const artist = videoData.author || '';
                            document.getElementById('current-video').textContent = 
                                artist ? `${artist} - ${title}` : title;
                        } else {
                            document.getElementById('current-video').textContent = 
                                'Now Playing...';
                        }
                    } catch (e) {
                        document.getElementById('current-video').textContent = 
                            'Now Playing...';
                    }
                }, 500);
            }
        }
    </script>
</body>
</html>              
